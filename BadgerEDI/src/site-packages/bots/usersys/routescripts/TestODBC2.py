'''
For testing ODBC driver issues.

@author: jknaus
'''

import pyodbc

import os
import traceback

def txtexc():
    return traceback.format_exc()

def execSP(cursor, spName):
    print 'Exec SP [%s]' % (spName,)
    try:
        results = cursor.execute(spName)
        results = cursor.fetchall()
        resultRows = list()
        # if not results.closed:
        for row in results:
            print row
            resultRows.append(row)
        print 'SP execution finished.'
        return resultRows        
    except:
        txt=txtexc()
        print 'TestODBC processing failed! Rolling back transaction.\n%s' % (txt,)
        raise

if __name__=='__main__':
   
    print 'Executing TestODBC'
    
    # detect OS and DB driver being used
    if os.name=='nt': # OS is windows
        print 'Detected that host OS is Windows. Using Microsoft MS SQL Server Native ODBC driver.'
    else:             # OS is Linux
        print 'Detected that host OS is Linux. Using Progress DataDirect Native MS SQL ODBC driver.'

    # setup DB connect parameters
    print 'PRODUCTION PRODUCTION *** Using JOMAR Production DB ***'
    cnxn = pyodbc.connect('DRIVER={SQL Server};SERVER=JOMAR;UID=sa;PWD=brent;DATABASE=ee8idbbd')
    cursor = cnxn.cursor()
    
    try:
        ixRows = execSP(cursor, "edi_GenInvoiceXML 'SPSMCX', 'ZZ', '0000872409', 'P'")
        invXMLText = ixRows[0][0]
        print 'Result XML returned by SP ================================================'
        print invXMLText
        print 'End of results ==========================================================='
        cnxn.commit()
    except:
        print 'TestODBC processing failed.'
        cnxn.rollback()
    finally:
        print 'TestODBC processing was uneventful.'
        cnxn.close()
        
