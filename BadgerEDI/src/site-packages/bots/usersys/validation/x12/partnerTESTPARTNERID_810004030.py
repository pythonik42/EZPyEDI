# vendor X12 810 4030 validation rules for TESTPARTNERID

from mycorpEDI.rules import *
from base_810004030 import fieldDescriptions, namedSegmentFormats

def getOutDocMap(out):
    return OutDocTreeMap(
        out, 'ST',
        ST01='810',
        ST02='@DocReferenceID',
        BIG=Seg(
            BIG01='@INV.Date',
            BIG02='@INV.Number',
            BIG03='@PO.Date',
            BIG04='@PO.Number',
            ),
        CUR=Seg(
            CUR01='SE',
            CUR02='@SO.CurrencyCode',
            ),
        REF=SegList(
            _Y_USES='IVN,VON',
            _IVN=Seg(
                _Y_IF='@VEN.DUNSNumber', 
                REF01='IA', 
                REF02='@VEN.DUNSNumber.zfill(11)'),
            _VON=Seg(
                _Y_IF='@SO.Number', 
                REF01='VN', 
                REF02='@SO.Number'),
            ),
        N1=SegList(
            _Y_USES='RI,ST,BT',
            _RI=Seg(
                _Y_IF='@VEN',
                N101='RI', 
                N102='@VEN.Name',
                N3=Seg(
                    N301='@VEN.AddressLine1',
                    N302='@VEN.AddressLine2',
                    ),
                N4=Seg(
                    N401='@VEN.City',
                    N402='@VEN.StateOrProvinceCode',
                    N403='@VEN.PostalCode',
                    N404='@VEN.CountryCode',
                    ),
                ),
            _ST=Seg(
                _Y_IF='@STO',
                N101='ST', 
                N102='@STO.Name',
                N103='92', 
                N104='@PO.ShipToLocation',
                N3=Seg(
                    N301='@STO.AddressLine1',
                    N302='@STO.AddressLine2',
                    ),
                N4=Seg(
                    N401='@STO.City',
                    N402='@STO.StateOrProvinceCode',
                    N403='@STO.PostalCode',
                    N404='@STO.CountryCode',
                    ),
                ),
            _BT=Seg(
                _Y_IF='@BTO',
                N101='BT', 
                N102='@BTO.Name',
                N3=Seg(
                    N301='@BTO.AddressLine1',
                    N302='@BTO.AddressLine2',
                    ),
                N4=Seg(
                    N401='@BTO.City',
                    N402='@BTO.StateOrProvinceCode',
                    N403='@BTO.PostalCode',
                    N404='@BTO.CountryCode',
                    ),
                ),
            ),
        ITD=Seg(
            ITD01='@X12.DiscountNotApplicable',
            ITD02='@X12.TOSDateQualifier',
            ITD06='@INV.TOSNetDueDate',
            ITD07='@INV.TOSNetDaysDue',
            ITD12='@INV.TOSNetDescription',
            ),
        DTM=SegList(
            _Y_USES='DSHP,EDLV',
            _DSHP=Seg(
                _Y_IF='@SHIP.ShipDate',
                DTM01='011', 
                DTM02='@SHIP.ShipDate'),
            _EDLV=Seg(
                _Y_IF='@SHIP.EstimatedDeliveryDate',
                DTM01='017', 
                DTM02='@SHIP.EstimatedDeliveryDate'),
            ),
        FOB=Seg(
            FOB01='@SHIP.MethodOfPayment',
            FOB02='@If(SHIP.FOBLocation, \'OR\', \'DE\')',
            FOB03='@SHIP.FOBLocation',
            ),
        IT1=ForLoop(
            'IT', 'INV.LineItems',
            IT101='@IT.LineNumber',
            IT102='@Decimal(IT.Quantity).to_integral_value()',
            IT103='@IT.UnitOfMeasure',
            IT104='@fmtStringAsMoney(IT.UnitPrice)',
            IT106='UP',
            IT107='@IT.UPCCode',
            IT108='VA',
            IT109='@IT.VendorStyleCode',
            PID=SegList(
                _Y_USES='PRD,CLR,SZ',
                _PRD   =Seg(_Y_IF='@IT.Description',    PID01='F', PID02='08', 
                                                        PID05='@IT.Description'),
                _CLR   =Seg(_Y_IF='@IT.Color',          PID01='F', PID02='73', 
                                                        PID05='@IT.Color'),
                _SZ    =Seg(_Y_IF='@IT.Size',           PID01='F', PID02='74', 
                                                        PID05='@IT.Size'),
                _BYCLR =Seg(_Y_IF='@IT.RequestedColor', PID01='F', PID02='75', 
                                                        PID05='@IT.RequestedColor'),
                ),
            ),
        TDS=Seg(
            TDS01='@fmtStringAsMoney(INV.TotalValue)',
            ),
        CAD=SegList(
            _Y_USES='BOLN,PREFN',
            # for LTL or long haul Trucks: Carrier BOL Number    OR
            _BOLN=Seg(
                _Y_IF='@X12.IsLTLOrTruckCarrier.get(CAR.Code, None)',
                CAD04='@X12.CarrierCodeToSCAC.get(CAR.Code, CAR.Code)',
                CAD07='BM', 
                CAD08='@CAR.BOLNumber'),
            # for parcel carriers: Pickup Ref Number
            _PREFN=Seg(
                _Y_IF='@X12.IsParcelCarrier.get(CAR.Code, None)',
                CAD04='@X12.CarrierCodeToSCAC.get(CAR.Code, CAR.Code)',
                CAD07='P8', 
                CAD08='@CAR.PickupReferenceNumber'),
            ),
        # shipment level charges/allowances
        SAC=Seg(
            _Y_IF='@CAR.FreightCharge and Decimal(CAR.FreightCharge) > 0.00',
            SAC01='C',
            SAC02='D240',
            SAC05='@fmtStringAsMoney(CAR.FreightCharge)',
            SAC12='02',
            SAC15='FREIGHT CHARGE',
            ),
        ISS=Seg(
            ISS01='@Decimal(INV.TotalNumberOfItems).to_integral_value()',
            ISS02='EA',
            ),
        )
      

contentRules = [         
    ('ST',                          RReqs('ST01', 'ST02', 'BIG', 'REF', 'N1[2-3]', 'IT1[1-1000]', 'TDS', 'CAD')),
    ('ST.ST01',                     RMustBe('810')),
    
    ('ST.BIG',                      RReqs('BIG01', 'BIG02', 'BIG04')),
       
    ('ST.REF',                      RReqs('_IVN')),
    ('ST.REF*',                     RReqs('REF01', 'REF02')),
    ('ST.REF?_IVN.REF01',           RMustBe('IA')),
    
    ('ST.N1',                       RReqs('_ST','_BT')),
    ('ST.N1?_ST',                   RReqs('N101')),
    ('ST.N1?_ST',                   ROneOf('N102', 'N103')),
    ('ST.N1?_ST',                   RAtomic('N103', 'N104')),
    ('ST.N1?_ST.N101',              RMustBe('ST')),
    ('ST.N1?_ST.N103',              RMustBe('92')),
    ('ST.N1?_BT',                   RReqs('N101', 'N102', 'N3', 'N4')),
    ('ST.N1?_BT',                   RAtomic('N103', 'N104')),
    ('ST.N1?_BT.N101',              RMustBe('BT')),
    ('ST.N1?_BT.N3',                RReqs('N301')),
    ('ST.N1?_BT.N4',                RReqs('N401', 'N402', 'N403')),
    ('ST.N1?_RI',                   RReqs('N101', 'N102', 'N3', 'N4')),
    ('ST.N1?_RI',                   RAtomic('N103', 'N104')),
    ('ST.N1?_RI.N101',              RMustBe('RI')),
    ('ST.N1?_RI.N3',                RReqs('N301')),
    ('ST.N1?_RI.N4',                RReqs('N401', 'N402', 'N403')),
    
    ('ST.IT1*',                     ROneOf('IT106', 'IT108')),
    ('ST.IT1*',                     RAtomic('IT106', 'IT107')),
    ('ST.IT1*',                     RAtomic('IT108', 'IT109')),
    ('ST.IT1*',                     RAtomic('IT102', 'IT103', 'IT104')),
    ('ST.IT1*.IT106',               RMustBe('UP')),                
    ('ST.IT1*.IT108',               RMustBe('VA')),                
    
    ('ST.IT1*.PID',                 RReqs('_PRD')),
    ('ST.IT1*.PID*',                RReqs('PID01', 'PID02', 'PID05')),
    ('ST.IT1*.PID*.PID01',          RMustBe('F')),
    ('ST.IT1*.PID*.PID02',          RValueIn('08', '73', '74', '75')),
    
    ('ST.TDS',                      RReqs('TDS01')),   

    ('ST.CAD',                      ROneOf('_BOLN', '_PREFN')),
    ('ST.CAD*',                     RReqs('CAD04')),
    ('ST.CAD*',                     RCond('CAD07', 'CAD08')),
    ('ST.CAD?_BOLN.CAD07',          RMustBe('BM')),
    ('ST.CAD?_PREFN.CAD07',         RMustBe('P8')),
    ]

