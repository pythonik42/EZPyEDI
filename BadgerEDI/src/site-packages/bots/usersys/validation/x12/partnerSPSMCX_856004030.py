# vendor X12 856 4030 validation rules for SPSMCX (the USMC Exchange)

from base_856004030 import fieldDescriptions, namedSegmentFormats

def getOutDocMap(out):
    return OutDocTreeMap(
        out, 'ST',
        ST01='856',
        ST02='@DocReferenceID',
        BSN=Seg(
            BSN01='@X12.ShipNoticeTypeCode',
            BSN02='@SHIPM.MasterBOL or SHIPM.Carrier.BOLNumber or (SHIPM.Order.PONumber and eMgr.getCustomerPONumber(SHIPM.Order.PONumber))',
            BSN03='@DateToday',
            BSN04='@TimeNow',
            BSN05='@X12.HierarchicalStructureCode',
            ),
        HL=ForLoop(
            'SHIP', '[SHIPM]',
            HL01='@IDGen.nextHSLevel1ID()',
            HL03='@X12.HSLevel1Code',
            TD1=Seg(
                TD101='@If(SHIP.NumberOfCartons, X12.PackagingTypeCode)',
                TD102='@SHIP.NumberOfCartons',
                TD106='@If(SHIP.Weight, X12.WeightQualifier)',
                TD107='@SHIP.Weight',
                TD108='@X12.WeightUnitOfMeasure',
                ),
            TD5=SegList(
                _Y_USES='SCAC',
                _SCAC=Seg(
                    _Y_IF='@SHIP.Carrier.Code or SHIP.Carrier.Name',
                    TD502='@SHIP.Carrier.Code and X12.CarrierCodeQualifier',
                    TD503='@X12.CarrierCodeToSCAC.get(SHIP.Carrier.Code, SHIP.Carrier.Code)',
                    TD505='@SHIP.Carrier.Name'),
                _RT=Seg(
                    _Y_IF='@SHIP.Carrier.RoutingNumber',
                    TD505='@SHIP.Carrier.RoutingNumber'),
                ),
            TD3=SegList(
                _Y_USES='TRL',
                _TRL=Seg(
                    _Y_IF='@X12.IsLTLOrTruckCarrier.get(SHIP.Carrier.Code, None) and SHIP.Carrier.EquipmentNumber',
                    TD301='TL',
                    TD303='@SHIP.Carrier.EquipmentNumber'),
                ),
            REF=SegList(
                _Y_USES='BOLN,CARN,PREFN',
                    # for LTL or long-haul Trucks: Carrier BOL Number and Carrier Pro Number
                    # sometimes both are used                
                _BOLN=Seg(
                    _Y_IF='@X12.IsLTLOrTruckCarrier.get(SHIP.Carrier.Code, None)',
                    REF01='BM', 
                    REF02='@SHIP.Carrier.BOLNumber'),
                _CARN=Seg(
                    _Y_IF='@X12.IsLTLOrTruckCarrier.get(SHIP.Carrier.Code, None)',
                    REF01='CN', 
                    REF02='@SHIP.Carrier.PRONumber or SHIP.Carrier.RoutingNumber'),
                # for parcel carriers: Pickup Ref Number or Tracking Number
                # use only one of these at a time
                _PREFN=Seg(
                    _Y_IF='@X12.IsParcelCarrier.get(SHIP.Carrier.Code, None)',
                    REF01='P8', 
                    REF02='@SHIP.Carrier.PickupReferenceNumber'),
                _TRACKN=Seg(
                    _Y_IF='@X12.IsParcelCarrier.get(SHIP.Carrier.Code, None)',
                    REF01='2I', 
                    REF02='@SHIP.Carrier.PickupReferenceNumber'),
                ),
            DTM=SegList(
                _Y_USES='DSHP,EDLV',
                _DSHP=Seg(
                    _Y_IF='@SHIP.ShipDate',
                    DTM01='011', 
                    DTM02='@SHIP.ShipDate'),
                _EDLV=Seg(
                    _Y_IF='@SHIP.EstimatedDeliveryDate',
                    DTM01='017', 
                    DTM02='@SHIP.EstimatedDeliveryDate'),
                _SDLV=Seg(
                    _Y_IF='@SHIP.ScheduledDeliveryDate',
                    DTM01='067', 
                    DTM02='@SHIP.ScheduledDeliveryDate'),
                ),
            FOB=Seg(
                FOB01='@SHIP.X12MethodOfPayment',
                FOB02='@If(SHIP.ShipTo.FOBLocation, \'OR\', \'DE\')',
                FOB03='@SHIP.ShipTo.FOBLocation',
                ),
            N1=SegList(
                _Y_USES='SF,ST',
                _SF=Seg(
                    N101='SF', 
                    N102='@VEN.Name',
                    N103='1', 
                    N104='@VEN.DUNSNumber.zfill(11)',
                    N3=Seg(
                        N301='@VEN.AddressLine1',
                        N302='@VEN.AddressLine2',
                        ),
                    N4=Seg(
                        N401='@VEN.City',
                        N402='@VEN.StateOrProvinceCode',
                        N403='@VEN.PostalCode',
                        N404='@VEN.CountryCode',
                        ),
                    ),
                _ST=Seg(
                    _Y_IF='@not XDOCK and SHIP.ShipTo',
                    N101='ST', 
                    N102='@SHIP.ShipTo.Name',
                    N103='92', 
                    N104='@SHIP.ShipTo.LocID',     
                    N3=Seg(
                        N301='@SHIP.ShipTo.AddressLine1',
                        N302='@SHIP.ShipTo.AddressLine2',
                        ),
                    N4=Seg(
                        N401='@SHIP.ShipTo.City',
                        N402='@SHIP.ShipTo.StateOrProvinceCode',
                        N403='@SHIP.ShipTo.PostalCode',
                        N404='@SHIP.ShipTo.CountryCode',
                        ),
                    ),
                _STWH=Seg(
                    _Y_IF='@XDOCK',
                    N101='ST', 
                    N102='@XDOCK.Name',
                    N103='92', 
                    N104='@XDOCK.LocID',
                    N3=Seg(
                        N301='@XDOCK.AddressLine1',
                        N302='@XDOCK.AddressLine2',
                        ),
                    N4=Seg(
                        N401='@XDOCK.City',
                        N402='@XDOCK.StateOrProvinceCode',
                        N403='@XDOCK.PostalCode',
                        N404='@XDOCK.CountryCode',
                        ),
                    ),
                ),
            HL=ReRootAtOutSeg(
                'ST',
                ForLoop(
                    'SO', '[sh.Order for sh in SHIPM.ShipmentDetails]',
                    HL01='@IDGen.nextHSLevel2ID()', 
                    HL02='@IDGen.lastHSLevel1ID()', 
                    HL03='@X12.HSLevel2Code',
                    PRF=Seg(
                        PRF01='@SO.PONumber', 
                        PRF02='@SO.PODate',
                        ),
                    REF=SegList(
                        _Y_USES='IVN',
                        _IVN=Seg(
                            _Y_IF='@VEN.DUNSNumber', 
                            REF01='IA', 
                            REF02='@VEN.DUNSNumber.zfill(11)'),
                        ),
                    HL=ReRootAtOutSeg(
                        'ST',
                        ForLoop(
                        'CASEID', 'SO.ExtraPackingDetails.getCaseIDsOnPS()',
                        HL01='@IDGen.nextHSLevel3ID()', 
                        HL02='@IDGen.lastHSLevel2ID()', 
                        HL03='@X12.HSLevel3Code',
                        MAN=Seg(
                            MAN01='@X12.MarksAndNumbersQualifier', 
                            MAN02='@CASEID',
                            ),
                        HL=ReRootAtOutSeg(
                            'ST',
                            ForLoop(
                                'IT', 'SO.ExtraPackingDetails.getPacksInCase(CASEID)',
                                HL01='@IDGen.nextHSLevel4ID()', 
                                HL02='@IDGen.lastHSLevel3ID()', 
                                HL03='@X12.HSLevel4Code',
                                LIN=Seg(
                                    LIN01='@IT.LineNumber',
                                    LIN02='UP',     
                                    LIN03='@IT.UPCCode',
                                    LIN04='VA',
                                    LIN05='@IT.VendorStyleCode',
                                    ),
                                SN1=Seg(
                                    SN102='@SO.ExtraPackingDetails.getQtyPacked(IT)',  
                                    SN103='@IT.UnitOfMeasure',
                                    SN105='@IT.QuantityOrdered',                       
                                    SN106='@IT.UnitOfMeasure',
                                    ),
                                PID=SegList(
                                    _Y_USES='PRD,CLR,SZ,BYCLR',
                                    _PRD   =Seg(_Y_IF='@IT.Description',    PID01='F', PID02='08', 
                                                                            PID05='@IT.Description'),
                                    _CLR   =Seg(_Y_IF='@IT.Color',          PID01='F', PID02='73', 
                                                                            PID05='@IT.Color'),
                                    _SZ    =Seg(_Y_IF='@IT.Size',           PID01='F', PID02='74', 
                                                                            PID05='@IT.Size'),
                                    _BYCLR =Seg(_Y_IF='@IT.RequestedColor', PID01='F', PID02='75', 
                                                                            PID05='@IT.RequestedColor'),
                                    ),
                        )), # _Items
                    )), # _Packs
            )), # _Orders
        )) #_Shipment
        
from badgerEDI.rules import *

contentRules = [         
    ('ST',                                 RReqs('ST01', 'ST02', 'BSN', 'HL')),
    ('ST.ST01',                            RMustBe('856')),
    ('ST.BSN',                             RReqs('BSN01', 'BSN02', 'BSN03', 'BSN04')),
    ('ST.BSN.BSN01',                       RMustBe('00')),
    ('ST.BSN.BSN05',                       RMustBe('0001')),
    
    ('ST.HL*',                             RReqs('HL01', 'HL03', 'TD5', 'REF', 'N1', 'DTM', 'HL')),
    ('ST.HL*.HL03',                        RMustBe('S')),
    ('ST.HL*.TD1',                         RReqs('TD101', 'TD102', 'TD106', 'TD107', 'TD108')),
    ('ST.HL*.TD1',                         RCond('TD101', 'TD102')),
    ('ST.HL*.TD1',                         RCond('TD106', 'TD107')),
    ('ST.HL*.TD1',                         RAtomic('TD107', 'TD108')),
    ('ST.HL*.TD1.TD101',                   RMustBe('CTN25')),
    ('ST.HL*.TD1.TD106',                   RMustBe('G')),
    ('ST.HL*.TD1.TD108',                   RValueIn('KG','LB')),
    ('ST.HL*.TD3*',                        RReqs('TD301', 'TD303')),
    ('ST.HL*.TD3*',                        RCond('TD301', 'TD303')),
    ('ST.HL*.TD3?_TRL',                    RReqs('TD301', 'TD303')),
    ('ST.HL*.TD3?_TRL',                    RCond('TD301', 'TD303')),
    ('ST.HL*.TD3?_TRL.TD301',              RMustBe('TL')),
    ('ST.HL*.TD5',                         RReqs('_SCAC')),
    ('ST.HL*.TD5?_SCAC',                   RCond('TD502', 'TD503')),
    ('ST.HL*.TD5?_SCAC',                   ROneOf('TD502', 'TD505')), 
    ('ST.HL*.TD5?_SCAC.TD502',             RMustBe('2')),
    ('ST.HL*.REF',                         ROneOf('_CARN', '_PREFN')),
    ('ST.HL*.REF',                         RAtomic('_BOLN', '_CARN')),
    ('ST.HL*.REF*',                        RReqs('REF01', 'REF02')),
    ('ST.HL*.REF*.REF01',                  RValueIn('BM', 'CN', 'P8')),
    ('ST.HL*.REF?_BOLN',                   RReqs('REF01', 'REF02')),
    ('ST.HL*.REF?_BOLN.REF01',             RMustBe('BM')),
    ('ST.HL*.REF?_CARN',                   RReqs('REF01', 'REF02')),
    ('ST.HL*.REF?_CARN.REF01',             RMustBe('CN')),
    ('ST.HL*.REF?_PREFN',                  RReqs('REF01', 'REF02')),
    ('ST.HL*.REF?_PREFN.REF01',            RMustBe('P8')),
    ('ST.HL*.REF?_TRACKN',                 RReqs('REF01', 'REF02')),
    ('ST.HL*.REF?_TRACKN.REF01',           RMustBe('2I')),
    ('ST.HL*.FOB',                         RReqs('FOB01')),
    ('ST.HL*.FOB',                         RCond('FOB03', 'FOB02')),
    ('ST.HL*.FOB.FOB01',                   RValueIn('CC','DF','PP','TP')),
    ('ST.HL*.FOB.FOB02',                   RValueIn('AC','DE','OR')),
    ('ST.HL*.DTM',                         RReqs('_DSHP', '_EDLV')),
    ('ST.HL*.DTM*',                        RReqs('DTM01', 'DTM02')),
    ('ST.HL*.DTM*.DTM01',                  RValueIn('011', '017')),
    ('ST.HL*.DTM?_DSHP',                   RReqs('DTM01', 'DTM02')),
    ('ST.HL*.DTM?_DSHP.DTM01',             RMustBe('011')),
    ('ST.HL*.DTM?_EDLV',                   RReqs('DTM01', 'DTM02')),
    ('ST.HL*.DTM?_EDLV.DTM01',             RMustBe('017')),
    ('ST.HL*.DTM?_SDLV',                   RReqs('DTM01', 'DTM02')),
    ('ST.HL*.DTM?_SDLV.DTM01',             RMustBe('067')),

    ('ST.HL*.N1',                          RReqs('_ST', '_SF')),
    ('ST.HL*.N1*',                         RAtomic('N103', 'N104')),
    ('ST.HL*.N1?_ST',                      RReqs('N101', 'N103', 'N104')),
    ('ST.HL*.N1?_ST.N101',                 RMustBe('ST')),
    ('ST.HL*.N1?_ST.N103',                 RMustBe('92')),
    ('ST.HL*.N1?_SF',                      RReqs('N101', 'N102')),
    ('ST.HL*.N1?_SF.N101',                 RMustBe('SF')),
    ('ST.HL*.N1?_SF.N103',                 RMustBe('1')),
    ('ST.HL*.N1*.N4.N404',                 RValueIn('US','CA','JP')),
    
    ('ST.HL*.HL*',                         RReqs('HL01', 'HL02', 'HL03', 'PRF', 'REF', 'HL[1-200000]')),
    ('ST.HL*.HL*.HL03',                    RMustBe('O')),                
    ('ST.HL*.HL*.N1*',                     RReqs('N102', 'N103')),
    ('ST.HL*.HL*.N1*',                     ROneOf('N102', 'N103')),
    ('ST.HL*.HL*.N1*',                     RAtomic('N103', 'N104')),
    ('ST.HL*.HL*.N1*.N101',                RValueIn('BY','SN','Z7')),
    ('ST.HL*.HL*.N1*.N103',                RMustBe('92')),
    ('ST.HL*.HL*.N1*.N3',                  RReqs('N301')),
    ('ST.HL*.HL*.N1*.N4',                  RReqs('N401', 'N402', 'N403', 'N404')),
    ('ST.HL*.HL*.REF',                     RReqs('_IVN')),
    ('ST.HL*.HL*.REF*',                    RReqs('REF01', 'REF02')),
    ('ST.HL*.HL*.REF?_IVN.REF01',          RMustBe('IA')),
    ('ST.HL*.HL*.PRF',                     RReqs('PRF01')),
    ('ST.HL*.HL*.TD1.TD101',               RMustBe('CTN25')),
    ('ST.HL*.HL*.TD1.TD106',               RMustBe('G')),
    ('ST.HL*.HL*.TD1.TD108',               RValueIn('KG','LB')),
    
    ('ST.HL*.HL*.HL*',                     RReqs('HL01', 'HL02', 'HL03', 'MAN', 'HL[1-200000]')),
    ('ST.HL*.HL*.HL*.HL03',                RValueIn('P','T')),                
    ('ST.HL*.HL*.HL*.MAN',                 RReqs('MAN01', 'MAN02')),
    ('ST.HL*.HL*.HL*.MAN',                 RAtomic('MAN04', 'MAN05')),
    ('ST.HL*.HL*.HL*.MAN.MAN01',           RMustBe('GM')),      
    ('ST.HL*.HL*.HL*.MAN.MAN04',           RMustBe('CP')),    
            
    ('ST.HL*.HL*.HL*.HL*',                 RReqs('HL01', 'HL02', 'HL03', 'LIN', 'SN1', 'PID')),
    ('ST.HL*.HL*.HL*.HL*.HL03',            RMustBe('I')),                
    ('ST.HL*.HL*.HL*.HL*.LIN',             RReqs('LIN02', 'LIN03')),
    ('ST.HL*.HL*.HL*.HL*.LIN',             RAtomic('LIN04', 'LIN05')),
    ('ST.HL*.HL*.HL*.HL*.LIN.LIN02',       RMustBe('UP')),                
    ('ST.HL*.HL*.HL*.HL*.LIN.LIN04',       RMustBe('VA')),                
    ('ST.HL*.HL*.HL*.HL*.SN1',             RReqs('SN102', 'SN103')),
    ('ST.HL*.HL*.HL*.HL*.SN1',             RAtomic('SN105', 'SN106')),
    ('ST.HL*.HL*.HL*.HL*.SN1.SN103',       RMustBe('EA')),                
    ('ST.HL*.HL*.HL*.HL*.SN1.SN106',       RMustBe('EA')),   
    ('ST.HL*.HL*.HL*.HL*.PID',             RReqs('_PRD')),
    ('ST.HL*.HL*.HL*.HL*.PID*',            RReqs('PID01', 'PID02', 'PID05')),             
    ('ST.HL*.HL*.HL*.HL*.PID*.PID01',      RMustBe('F')),             
    ('ST.HL*.HL*.HL*.HL*.PID*.PID02',      RValueIn('08','73','74','75')),             
    ('ST.HL*.HL*.HL*.HL*.PID?_PRD',        RReqs('PID01', 'PID02', 'PID05')),             
    ('ST.HL*.HL*.HL*.HL*.PID?_PRD.PID01',  RMustBe('F')),             
    ('ST.HL*.HL*.HL*.HL*.PID?_PRD.PID02',  RMustBe('08')),             
    ('ST.HL*.HL*.HL*.HL*.PID?_CLR',        RReqs('PID01', 'PID02', 'PID05')),             
    ('ST.HL*.HL*.HL*.HL*.PID?_CLR.PID01',  RMustBe('F')),             
    ('ST.HL*.HL*.HL*.HL*.PID?_CLR.PID02',  RMustBe('73')),             
    ('ST.HL*.HL*.HL*.HL*.PID?_SZ',         RReqs('PID01', 'PID02', 'PID05')),             
    ('ST.HL*.HL*.HL*.HL*.PID?_SZ.PID01',   RMustBe('F')),             
    ('ST.HL*.HL*.HL*.HL*.PID?_SZ.PID02',   RMustBe('74')),             
    ('ST.HL*.HL*.HL*.HL*.PID?_BYCLR',      RReqs('PID01', 'PID02', 'PID05')),             
    ('ST.HL*.HL*.HL*.HL*.PID?_BYCLR.PID01',RMustBe('F')),             
    ('ST.HL*.HL*.HL*.HL*.PID?_BYCLR.PID02',RMustBe('75')),             
]
